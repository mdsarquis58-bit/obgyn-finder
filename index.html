<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>OB/GYN Evidence Finder</title>
<link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;700&display=swap" rel="stylesheet">

<style>
:root{
  --ink:#0f172a;         /* slate-900 */
  --muted:#475569;       /* slate-600 */
  --line:#e2e8f0;        /* slate-200 */
  --bg:#ffffff;
  --accent:#2563eb;      /* blue-600 */
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:'Lora',serif}
header{padding:24px 16px;border-bottom:1px solid var(--line)}
h1{margin:0 0 6px;font-size:28px;color:var(--accent)}
.tag{margin:0;color:var(--muted)}
.container{max-width:980px;margin:20px auto;padding:0 16px}
.card{border:1px solid var(--line);border-radius:16px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.03);padding:16px;margin:16px 0}
.section-title{margin:0 0 10px;color:var(--accent);font-size:20px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.input{flex:1;min-width:220px;padding:10px 12px;border:1px solid var(--line);border-radius:12px;font-family:inherit}
select.input{min-width:180px}
.btn{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700}
.btn:hover{filter:brightness(.95)}
.btn-outline{background:#fff;border:1px solid var(--accent);color:var(--accent);padding:10px 14px;border-radius:12px;cursor:pointer}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px;margin:16px 0}
.result{border:1px solid var(--line);border-radius:16px;padding:14px;background:#fff;display:flex;flex-direction:column;gap:8px}
.title{font-weight:700;line-height:1.25}
.meta{color:var(--muted);font-size:14px}
.abstract{color:#1f2937;font-size:15px}
.actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
.badge{display:inline-block;font-size:12px;color:#fff;background:var(--accent);padding:3px 8px;border-radius:999px}
a{color:var(--accent);text-decoration:none}
a:hover{text-decoration:underline}
dialog{width:min(720px,92vw);border:1px solid var(--line);border-radius:16px;padding:0}
dialog::backdrop{background:rgba(0,0,0,.2)}
.modal-body{padding:16px}
label{display:block;font-size:14px;color:#1f2937;margin:8px 0}
textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;font-family:inherit}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
@media(max-width:640px){.grid-2{grid-template-columns:1fr}}
.small{font-size:12px;color:var(--muted)}
hr{border:none;border-top:1px solid var(--line);margin:8px 0}
</style>
</head>
<body>
<header>
  <h1>OB/GYN Evidence Finder</h1>
  <p class="tag">Find the latest, most relevant studies — with quick critical appraisal and SR/RCT comparison.</p>
</header>

<main class="container">

  <!-- Search / Filters -->
  <section class="card">
    <h2 class="section-title">Search PubMed</h2>
    <form id="queryForm" class="row">
      <input id="q" class="input" placeholder='e.g., (preeclampsia OR "intraamniotic infection")' />
      <select id="subspecialty" class="input">
        <option value="">All subspecialties</option>
        <option value="mfm">Maternal–Fetal Medicine</option>
        <option value="gyn_onc">Gynecologic Oncology</option>
        <option value="rei">REI</option>
        <option value="urogyn">Urogynecology</option>
        <option value="general">General Gyn/OB</option>
      </select>
      <select id="design" class="input">
        <option value="">All designs</option>
        <option value="meta_analysis">Systematic Review / Meta-analysis</option>
        <option value="rct">Randomized Trial</option>
        <option value="cohort">Cohort</option>
        <option value="case_control">Case–Control</option>
        <option value="diagnostic">Diagnostic Accuracy</option>
        <option value="case_series">Case Series / Report</option>
        <option value="narrative_review">Narrative Review</option>
      </select>
      <label class="small">From <input id="dateFrom" type="date" class="input" style="min-width:160px"></label>
      <label class="small">To <input id="dateTo" type="date" class="input" style="min-width:160px"></label>
      <select id="sortBy" class="input">
        <option value="published_online">Sort: Published (online)</option>
        <option value="impact">Sort: Impact score</option>
        <option value="quality">Sort: Quality score</option>
        <option value="recency">Sort: PubMed recency</option>
      </select>
      <button class="btn" type="submit">Search</button>
    </form>
    <p class="small">Tip: Use PubMed date tags like <code>2025/09[pdat]</code> inside your query if you like.</p>
  </section>

  <!-- Results -->
  <section class="grid" id="results"></section>

  <!-- Saved (local only) -->
  <section class="card">
    <h2 class="section-title">Saved to Hub (local)</h2>
    <div id="saved"></div>
    <div class="row" style="margin-top:8px">
      <button id="exportJson" class="btn-outline">Export JSON</button>
      <button id="clearSaved" class="btn-outline">Clear</button>
    </div>
  </section>

</main>

<!-- Appraisal modal -->
<dialog id="appraiseDialog">
  <form method="dialog" class="modal-body" id="appraiseForm">
    <h3 class="section-title">Critical Appraisal</h3>
    <div class="grid-2">
      <label>Study design
        <select id="designSel" class="input">
          <option value="meta_analysis">Meta-analysis / Systematic Review</option>
          <option value="rct">Randomized Controlled Trial</option>
          <option value="cohort" selected>Cohort</option>
          <option value="case_control">Case–Control</option>
          <option value="diagnostic">Diagnostic Accuracy</option>
          <option value="case_series">Case Series / Report</option>
          <option value="narrative_review">Narrative Review</option>
        </select>
      </label>
      <label>Level of evidence
        <select id="loe" class="input">
          <option value="I">I</option>
          <option value="II" selected>II</option>
          <option value="III">III</option>
          <option value="IV">IV</option>
        </select>
      </label>
    </div>
    <label>Clinical question (1 sentence)
      <textarea id="cq" rows="2"></textarea>
    </label>
    <div class="grid-2">
      <label>P (Population)<input id="p" class="input"/></label>
      <label>I/E (Intervention/Exposure)<input id="i" class="input"/></label>
      <label>C (Comparison)<input id="c" class="input"/></label>
      <label>O (Outcomes)<input id="o" class="input"/></label>
    </div>
    <label>Key findings (3 bullets)
      <textarea id="keyPoints" rows="3" placeholder="• …&#10;• …&#10;• …"></textarea>
    </label>
    <label>Limitations / confounders (2–4)
      <textarea id="limits" rows="3" placeholder="• …&#10;• …"></textarea>
    </label>
    <label>Practice impact (2–3)
      <textarea id="impact" rows="3" placeholder="• …&#10;• …"></textarea>
    </label>
    <label>Research next steps (1–2)
      <textarea id="nextSteps" rows="2" placeholder="• …"></textarea>
    </label>
    <div class="row" style="justify-content:flex-end;margin-top:8px">
      <button class="btn-outline" value="cancel">Cancel</button>
      <button class="btn" id="saveAppraisal" value="default">Save</button>
    </div>
  </form>
</dialog>

<script>
/* =======================
   Minimal, robust finder
   ======================= */

const EUTILS = "https://eutils.ncbi.nlm.nih.gov/entrez/eutils";
const LS_ARTICLES = "obgyn_hub_saved";

/* utils */
const $ = (sel, el=document)=>el.querySelector(sel);
const escapeHTML = s => s?.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])) || "";

/* classify + score */
function classifySubspecialty(text=""){
  const t = text.toLowerCase();
  if (/(ovarian|cervical|endometrial|vulvar|anal cancer|hpv)/.test(t)) return "gyn_onc";
  if (/(preeclampsia|intraamniotic|preterm|fetal|placenta|gestational)/.test(t)) return "mfm";
  if (/(ivf|amh|anovulation|pcos|gonadotropin|letrozole)/.test(t)) return "rei";
  if (/(incontinence|pelvic floor|prolapse|urogenital)/.test(t)) return "urogyn";
  return "general";
}
function classifyDesign(text=""){
  const t = text.toLowerCase();
  if (/meta-?analysis|systematic review/.test(t)) return "meta_analysis";
  if (/randomi[sz]ed|trial|placebo|double-?blind/.test(t)) return "rct";
  if (/cohort|prospective|retrospective/.test(t)) return "cohort";
  if (/case[- ]control/.test(t)) return "case_control";
  if (/sensitivity|specificity|auc|accuracy|validation|sequencing/.test(t)) return "diagnostic";
  if (/case series|case report/.test(t)) return "case_series";
  if (/review/.test(t)) return "narrative_review";
  return "narrative_review";
}
function levelOfEvidence(design){
  return ({meta_analysis:"I", rct:"I", cohort:"II", case_control:"II", diagnostic:"II", case_series:"III", narrative_review:"III"}[design]) || "III";
}
function scoreQuality(design, n=0){
  const base = {meta_analysis:.95,rct:.9,cohort:.75,case_control:.7,diagnostic:.75,case_series:.45,narrative_review:.4}[design] || .5;
  const bonus = n ? Math.min(.1, Math.log10(Math.max(1,n))*0.03) : 0;
  return +(Math.min(1, base+bonus)).toFixed(3);
}
function scoreImpact(text){
  const hit = /(guideline|screening|mortality|preeclampsia|preterm|hpv|endometriosis)/i.test(text);
  return +(Math.min(1, 0.6 + (hit?0.1:0))).toFixed(3);
}

/* build query */
function buildQuery(q, subspecialty, design){
  const parts=[];
  if (q && q.trim()) parts.push((${q.trim()}));
  const subMap={
    mfm:'(preeclampsia[MeSH Terms] OR placenta[Title/Abstract] OR fetal[Title/Abstract] OR "preterm birth"[Title/Abstract])',
    gyn_onc:'(ovarian[Title/Abstract] OR cervical[Title/Abstract] OR endometrial[Title/Abstract] OR HPV[Title/Abstract])',
    rei:'(infertility[MeSH Terms] OR IVF[Title/Abstract] OR "anti-mullerian hormone"[Title/Abstract] OR PCOS[Title/Abstract])',
    urogyn:'("pelvic floor"[Title/Abstract] OR incontinence[Title/Abstract] OR prolapse[Title/Abstract])',
    general:'(obstetrics[Title/Abstract] OR gynecology[Title/Abstract])'
  };
  if (subspecialty && subMap[subspecialty]) parts.push(subMap[subspecialty]);
  const designMap={
    meta_analysis:'(meta-analysis[Publication Type] OR systematic[sb])',
    rct:'"randomized controlled trial"[Publication Type]',
    cohort:'(cohort[Title/Abstract] OR prospective[Title/Abstract] OR retrospective[Title/Abstract])',
    case_control:'"case-control"[Title/Abstract]',
    diagnostic:'(sensitivity[Title/Abstract] OR specificity[Title/Abstract] OR accuracy[Title/Abstract])',
    case_series:'("case report"[Publication Type] OR "case reports"[Publication Type] OR "case series"[Title/Abstract])',
    narrative_review:'(review[Publication Type] AND NOT systematic[sb])'
  };
  if (design && designMap[design]) parts.push(designMap[design]);
  parts.push('(obstetrics[Title/Abstract] OR gynecology[Title/Abstract] OR pregnancy[Title/Abstract])');
  return parts.join(' AND ');
}

/* PubMed helpers */
async function esearchIds(term, from, to, retmax=100){
  const p=new URLSearchParams({
    db:"pubmed", term, retmode:"json", retmax, sort:"pub+date",
    datetype:"pdat", mindate:from||"", maxdate:to||""
  });
  const r=await fetch(${EUTILS}/esearch.fcgi?${p});
  const j=await r.json();
  return j.esearchresult?.idlist || [];
}
async function esummary(ids){
  const p=new URLSearchParams({db:"pubmed", id:ids.join(","), retmode:"json"});
  const r=await fetch(${EUTILS}/esummary.fcgi?${p});
  const j=await r.json();
  return j.result || {};
}
async function efetchAbstractText(pmid){
  try{
    const p=new URLSearchParams({db:"pubmed", id:pmid, rettype:"abstract", retmode:"text"});
    const r=await fetch(${EUTILS}/efetch.fcgi?${p});
    return (await r.text()).trim();
  }catch{return ""}
}

/* render */
function renderResults(items){
  const wrap=$("#results");
  wrap.innerHTML = items.map(r=>
    <article class="result" data-pmid="${r.pmid}">
      <div class="title">${escapeHTML(r.title)}</div>
      <div class="meta">
        ${escapeHTML(r.journal)} · ${escapeHTML(r.date || "")}
        · <a href="${r.url}" target="_blank">PMID ${r.pmid}</a>
        ${r.doi ?  · <a href="https://doi.org/${r.doi}" target="_blank">DOI</a> : ""}
      </div>
      <div class="meta">Design: ${r.study_design.toUpperCase()} (LoE ${r.level_of_evidence}) · Subspecialty: ${r.subspecialty.toUpperCase()} · Quality: ${r.quality} · Impact: ${r.impact}</div>
      <div class="abstract">${escapeHTML(r.abstract)}</div>
      <div class="actions">
        <span class="badge">${r.subspecialty.toUpperCase()}</span>
        <button class="btn save">Save</button>
        <button class="btn-outline appraise">Appraise</button>
        <button class="btn-outline compare">Compare SR/RCT</button>
      </div>
      <div class="meta" id="cmp-${r.pmid}"></div>
    </article>
  ).join("");
}

/* saved (localStorage only) */
function saveLocal(rec){
  const arr = JSON.parse(localStorage.getItem(LS_ARTICLES)||"[]");
  const ex = arr.find(x=>x.pmid===rec.pmid);
  if (ex) Object.assign(ex, rec); else arr.unshift(rec);
  localStorage.setItem(LS_ARTICLES, JSON.stringify(arr));
  renderSaved();
}
function renderSaved(){
  const arr = JSON.parse(localStorage.getItem(LS_ARTICLES)||"[]");
  const box=$("#saved");
  if(!arr.length){ box.innerHTML="<p class='meta'>Nothing saved yet.</p>"; return; }
  box.innerHTML = arr.map(a=>
    <div class="result">
      <div class="title">${escapeHTML(a.title)}</div>
      <div class="meta">${escapeHTML(a.journal)} · ${escapeHTML(a.date||"")} · ${a.study_design?.toUpperCase()} (LoE ${a.level_of_evidence||"?"})</div>
      <div class="abstract">${escapeHTML(a.abstract||"")}</div>
      <div class="actions">
        <button class="btn-outline appraise" data-pmid="${a.pmid}">Edit Appraisal</button>
        <button class="btn-outline compare" data-pmid="${a.pmid}">Compare SR/RCT</button>
        <a class="btn-outline" href="${a.url}" target="_blank">Open PubMed</a>
      </div>
      <div class="meta" id="cmp-${a.pmid}"></div>
    </div>
  ).join("");
}

/* appraisal modal */
let currentPMID=null;
function openAppraisal(pmid){
  currentPMID=pmid;
  const arr = JSON.parse(localStorage.getItem(LS_ARTICLES)||"[]");
  const a = arr.find(x=>x.pmid===pmid)||{};
  $("#designSel").value = a.study_design||"cohort";
  $("#loe").value = a.level_of_evidence||"II";
  $("#cq").value = a.clinical_question||"";
  $("#p").value = a.pico?.P||"";
  $("#i").value = a.pico?.I||"";
  $("#c").value = a.pico?.C||"";
  $("#o").value = a.pico?.O||"";
  $("#keyPoints").value = (a.key_points||[]).join("\n");
  $("#limits").value = (a.limitations||[]).join("\n");
  $("#impact").value = (a.practice_impact||[]).join("\n");
  $("#nextSteps").value = (a.research_next||[]).join("\n");
  $("#appraiseDialog").showModal();
}
function saveAppraisal(){
  const arr = JSON.parse(localStorage.getItem(LS_ARTICLES)||"[]");
  const rec = arr.find(x=>x.pmid===currentPMID);
  if(!rec) return $("#appraiseDialog").close();
  rec.study_design=$("#designSel").value;
  rec.level_of_evidence=$("#loe").value;
  rec.clinical_question=$("#cq").value.trim();
  rec.pico={P:$("#p").value.trim(), I:$("#i").value.trim(), C:$("#c").value.trim(), O:$("#o").value.trim()};
  rec.key_points=$("#keyPoints").value.split("\n").map(s=>s.replace(/^•\s?/,"").trim()).filter(Boolean);
  rec.limitations=$("#limits").value.split("\n").map(s=>s.replace(/^•\s?/,"").trim()).filter(Boolean);
  rec.practice_impact=$("#impact").value.split("\n").map(s=>s.replace(/^•\s?/,"").trim()).filter(Boolean);
  rec.research_next=$("#nextSteps").value.split("\n").map(s=>s.replace(/^•\s?/,"").trim()).filter(Boolean);
  saveLocal(rec);
  $("#appraiseDialog").close();
}

/* COMPARE SR/RCT (fixed) */
async function compareSRRCTFor(rec){
  // Build a conservative query: key terms from title + SR/RCT filters + last 5 years
  const keyTerms = rec.title.replace(/[^\w\s]/g," ").split(/\s+/).slice(0,8).join(" ");
  const fiveYearsAgo = new Date(); fiveYearsAgo.setFullYear(fiveYearsAgo.getFullYear()-5);
  const y = fiveYearsAgo.getFullYear();

  const term = (${keyTerms}) AND (systematic[sb] OR meta-analysis[ptyp] OR "randomized controlled trial"[Publication Type]) AND (${y}:3000[pdat]);
  const ids = await esearchIds(term, null, null, 20);
  if(!ids.length) return { stance:"No SR/RCT found (last 5y)", priors:[] };

  const meta = await esummary(ids);
  const list = ids.map(id => meta[id]).filter(Boolean).map(x => ({
    pmid:x.uid, title:x.title, journal:x.fulljournalname, date:x.pubdate, type:(x.pubtype||[]).join(", ")
  }));

  // Simple stance message
  const hasSR = list.some(p => /Systematic Review|Meta-Analysis/i.test(p.type));
  const hasRCT = list.some(p => /Randomized Controlled Trial/i.test(p.type));
  const stance = hasSR || hasRCT ? "Prior high-level evidence exists" : "Evidence uncertain";
  return { stance, priors:list };
}

/* events */
document.getElementById("queryForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const q=$("#q").value.trim();
  const subs=$("#subspecialty").value;
  const des=$("#design").value;
  const from=$("#dateFrom").value||"";
  const to=$("#dateTo").value||"";
  const sortBy=$("#sortBy").value;

  const term = buildQuery(q, subs, des);
  $("#results").innerHTML = "<p class='meta'>Searching PubMed…</p>";

  const ids = await esearchIds(term, from, to, 120);
  if(!ids.length){ $("#results").innerHTML="<p class='meta'>No results.</p>"; return; }

  const meta = await esummary(ids);
  const out=[];
  for(const id of ids){
    const m = meta[id]; if(!m) continue;
    const abs = await efetchAbstractText(m.uid);
    const titleAbs = ${m.title} ${abs};
    const study_design = classifyDesign(titleAbs);
    out.push({
      pmid:m.uid,
      title:m.title,
      journal:m.fulljournalname,
      date:m.pubdate,
      doi:(m.elocationid && /10\.\d{4,9}\/\S+/.exec(m.elocationid)?.[0]) || "",
      abstract:abs,
      url:https://pubmed.ncbi.nlm.nih.gov/${m.uid}/,
      subspecialty: classifySubspecialty(titleAbs),
      study_design,
      level_of_evidence: levelOfEvidence(study_design),
      quality: scoreQuality(study_design, 0),
      impact:  scoreImpact(titleAbs)
    });
  }

  // sort
  out.sort((a,b)=>{
    if (sortBy==="impact") return b.impact - a.impact;
    if (sortBy==="quality") return b.quality - a.quality;
    if (sortBy==="recency") return new Date(b.date) - new Date(a.date);
    // default: published date field fallback
    return new Date(b.date) - new Date(a.date);
  });

  renderResults(out);
});

document.addEventListener("click", async (e)=>{
  const card = e.target.closest(".result"); 
  const savedCard = e.target.closest("#saved .result");
  const pmid = card?.dataset.pmid || savedCard?.querySelector(".appraise")?.dataset.pmid;
  if(!pmid) return;

  // build current record snapshot (from DOM or saved)
  let rec;
  const arr = JSON.parse(localStorage.getItem(LS_ARTICLES)||"[]");
  rec = arr.find(x=>x.pmid===pmid);
  if(!rec && card){
    rec = {
      pmid,
      title: $(".title", card).textContent.trim(),
      journal: $(".meta", card).textContent.split(" · ")[0],
      date: $(".meta", card).textContent.split(" · ")[1],
      abstract: $(".abstract", card).textContent.trim(),
      url: $("a[href^='https://pubmed']", card).href,
      subspecialty: "general",
      study_design: "cohort",
      level_of_evidence: "II",
      quality: .75, impact: .6
    };
  }

  if(e.target.classList.contains("save")){
    saveLocal(rec);
    e.target.textContent="Saved ✓";
  }
  if(e.target.classList.contains("appraise")){
    openAppraisal(pmid);
  }
  if(e.target.classList.contains("compare")){
    const box = document.getElementById(cmp-${pmid}) || (savedCard && savedCard.querySelector(#cmp-${pmid}));
    if(box){ box.textContent="Searching for SR/RCT (last 5 years)…"; }
    try{
      const cmp = await compareSRRCTFor(rec);
      const lines = cmp.priors.slice(0,5).map(p=>• ${p.title} (${p.type})).join("<br>");
      if(box) box.innerHTML = <strong>${cmp.stance}</strong>${cmp.priors.length? "<br>"+lines : ""};
    }catch(err){
      if(box) box.textContent="Comparison unavailable.";
      console.error(err);
    }
  }
});

/* modal controls */
document.getElementById("saveAppraisal").addEventListener("click",(e)=>{e.preventDefault();saveAppraisal();});
document.getElementById("exportJson").addEventListener("click",()=>{
  const data = localStorage.getItem(LS_ARTICLES)||"[]";
  const blob = new Blob([data],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="obgyn_saved.json";
  a.click();
});
document.getElementById("clearSaved").addEventListener("click",()=>{
  if(confirm("Clear locally saved items?")){ localStorage.removeItem(LS_ARTICLES); renderSaved(); }
});

/* init */
renderSaved();
</script>
</body>
</html>
